<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>长方体体积可视化教学工具 - 增强版</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: #333;
            overflow-x: hidden;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
            width: 100%;
        }
        .header h1 {
            font-size: 2.2rem;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        .header p {
            color: #7f8c8d;
            font-size: 1.1rem;
        }
        .container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 30px;
            max-width: 1600px;
            width: 100%;
        }
        .controls {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
        }
        .control-group {
            margin-bottom: 20px;
        }
        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
            font-size: 1.1rem;
        }
        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .slider-container span {
            min-width: 60px;
            text-align: center;
            font-weight: bold;
            color: #3498db;
        }
        input[type="range"] {
            flex: 1;
            height: 10px;
            -webkit-appearance: none;
            appearance: none;
            background: #e0e0e0;
            border-radius: 5px;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            transition: background 0.3s;
        }
        input[type="range"]::-webkit-slider-thumb:hover {
            background: #2980b9;
        }
        .unit-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        .unit-selector select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #ddd;
            background: white;
            width: 100%;
        }
        .buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
        }
        button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
            min-width: 80px;
        }
        #reset {
            background: #e74c3c;
            color: white;
        }
        #reset:hover {
            background: #c0392b;
        }
        #clear {
            background: #7f8c8d;
            color: white;
        }
        #clear:hover {
            background: #636e72;
        }
        #fullscreen {
            background: #2ecc71;
            color: white;
        }
        #fullscreen:hover {
            background: #27ae60;
        }
        #layer-view {
            background: #9b59b6;
            color: white;
        }
        #layer-view:hover {
            background: #8e44ad;
        }
        #marker-mode {
            background: #f39c12;
            color: white;
        }
        #marker-mode:hover {
            background: #d35400;
        }
        #function-mode {
            background: #16a085;
            color: white;
        }
        #function-mode:hover {
            background: #1abc9c;
        }
        #developer-mode {
            background: #34495e;
            color: white;
        }
        #developer-mode:hover {
            background: #2c3e50;
        }
        .visualization {
            flex: 1;
            min-width: 300px;
            max-width: 1000px;
            height: 600px;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        .volume-display {
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-align: center;
            color: #2c3e50;
        }
        .volume-display span {
            color: #e74c3c;
            font-weight: bold;
        }
        #cube-container {
            width: 100%;
            height: 500px;
            background: #f8f9fa;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        .axis-label {
            position: absolute;
            font-weight: bold;
            color: #3498db;
            background: rgba(255, 255, 255, 0.7);
            padding: 2px 8px;
            border-radius: 4px;
            z-index: 10;
        }
        .length-label {
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
        }
        .width-label {
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
        }
        .height-label {
            top: 10px;
            left: 20px;
        }
        .instructions {
            margin-top: 20px;
            text-align: center;
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        .social-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 30px;
            padding: 15px 25px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 1400px;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #3498db;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        .chat-info {
            display: flex;
            align-items: center;
            gap: 15px;
            color: #7f8c8d;
        }
        .tag {
            background: #3498db;
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        /* 模态窗口样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .close-modal {
            font-size: 1.5rem;
            cursor: pointer;
            color: #7f8c8d;
        }
        .function-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 1rem;
        }
        .geometry-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        .geometry-btn {
            padding: 10px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .geometry-btn:hover {
            background: #2980b9;
        }
        .annotation-canvas {
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-top: 10px;
            background: white;
        }
        .toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .tool-btn {
            padding: 8px 12px;
            background: #ecf0f1;
            border: 1px solid #bdc3c7;
            border-radius: 5px;
            cursor: pointer;
        }
        .tool-btn.active {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }
        @media (max-width: 1200px) {
            .container {
                flex-direction: column;
                align-items: center;
            }
            .controls, .visualization {
                max-width: 100%;
            }
            .visualization {
                height: 500px;
            }
            #cube-container {
                height: 400px;
            }
            .social-bar {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
        }
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }
            .controls {
                padding: 15px;
            }
            .slider-container {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            input[type="range"] {
                width: 100%;
            }
            .buttons {
                flex-direction: column;
            }
            .volume-display {
                font-size: 1.2rem;
            }
            .geometry-selector {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>长方体体积可视化教学工具 - 增强版</h1>
        <p>通过调整长、宽、高，直观理解长方体体积的计算原理</p>
    </div>

    <div class="container">
        <div class="controls">
            <div class="control-group">
                <label for="length">长:</label>
                <div class="slider-container">
                    <input type="range" id="length" min="1" max="1500" value="8" step="1">
                    <span id="length-value">8</span>
                </div>
                <div class="unit-selector">
                    <select id="length-unit">
                        <option value="0.000001">微米</option>
                        <option value="0.001">毫米</option>
                        <option value="1" selected>厘米</option>
                        <option value="10">分米</option>
                        <option value="100">米</option>
                    </select>
                </div>
            </div>
            <div class="control-group">
                <label for="width">宽:</label>
                <div class="slider-container">
                    <input type="range" id="width" min="1" max="1500" value="3" step="1">
                    <span id="width-value">3</span>
                </div>
                <div class="unit-selector">
                    <select id="width-unit">
                        <option value="0.000001">微米</option>
                        <option value="0.001">毫米</option>
                        <option value="1" selected>厘米</option>
                        <option value="10">分米</option>
                        <option value="100">米</option>
                    </select>
                </div>
            </div>
            <div class="control-group">
                <label for="height">高:</label>
                <div class="slider-container">
                    <input type="range" id="height" min="1" max="1500" value="5" step="1">
                    <span id="height-value">5</span>
                </div>
                <div class="unit-selector">
                    <select id="height-unit">
                        <option value="0.000001">微米</option>
                        <option value="0.001">毫米</option>
                        <option value="1" selected>厘米</option>
                        <option value="10">分米</option>
                        <option value="100">米</option>
                    </select>
                </div>
            </div>
            <div class="buttons">
                <button id="reset">还原</button>
                <button id="clear">清空</button>
                <button id="layer-view">分层</button>
                <button id="marker-mode">标记模式</button>
                <button id="function-mode">函数可视化</button>
                <button id="developer-mode">开发者模式</button>
                <button id="fullscreen">全屏</button>
            </div>
        </div>

        <div class="visualization">
            <div class="volume-display">
                体积 = <span id="volume">120</span> 立方厘米
            </div>
            <div id="cube-container"></div>
            <div class="axis-label length-label">长</div>
            <div class="axis-label width-label">宽</div>
            <div class="axis-label height-label">高</div>
            <div class="instructions">
                拖动滑块调整长方体的尺寸，观察体积的变化。使用鼠标拖动可以旋转视图。
            </div>
        </div>
    </div>

    <div class="social-bar">
        <div class="user-info">
            <div class="avatar">jS</div>
            <div>数学可视化教学工具</div>
        </div>
        <div class="chat-info">
            <span class="tag">教育科技</span>
            <span>增强版 v2.0</span>
        </div>
    </div>

    <!-- 函数可视化模态窗口 -->
    <div id="function-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>函数可视化工具</h3>
                <span class="close-modal">&times;</span>
            </div>
            <input type="text" class="function-input" id="function-expression" placeholder="输入函数表达式，如: Math.sin(x) * Math.cos(z)" value="Math.sin(x) * Math.cos(z)">
            <div class="buttons">
                <button id="plot-2d">绘制2D图像</button>
                <button id="plot-3d">绘制3D图像</button>
                <button id="clear-function">清除函数</button>
            </div>
        </div>
    </div>

    <!-- 开发者模式模态窗口 -->
    <div id="developer-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>开发者模式 - 创建几何体</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="geometry-selector">
                <button class="geometry-btn" data-type="sphere">球体</button>
                <button class="geometry-btn" data-type="cylinder">圆柱体</button>
                <button class="geometry-btn" data-type="cone">圆锥体</button>
                <button class="geometry-btn" data-type="torus">圆环</button>
                <button class="geometry-btn" data-type="pyramid">金字塔</button>
                <button class="geometry-btn" data-type="plane">平面</button>
            </div>
            <div class="control-group">
                <label for="geo-size">尺寸:</label>
                <input type="range" id="geo-size" min="1" max="50" value="5" step="1">
                <span id="geo-size-value">5</span>
            </div>
            <div class="control-group">
                <label for="geo-color">颜色:</label>
                <input type="color" id="geo-color" value="#3498db">
            </div>
            <button id="add-geometry">添加到场景</button>
        </div>
    </div>

    <!-- 注释画布模态窗口 -->
    <div id="annotation-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>添加注释</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="toolbar">
                <button class="tool-btn active" data-tool="pen">画笔</button>
                <button class="tool-btn" data-tool="eraser">橡皮擦</button>
                <button class="tool-btn" data-tool="text">文字</button>
            </div>
            <canvas id="annotation-canvas" class="annotation-canvas" width="400" height="300"></canvas>
            <div class="buttons" style="margin-top: 15px;">
                <button id="save-annotation">保存注释</button>
                <button id="clear-annotation">清除画布</button>
            </div>
        </div>
    </div>

    <script>
        let scene, camera, renderer, controls;
        let cube, cubeGroup, platform;
        let length = 8, width = 3, height = 5;
        let layerMode = false;
        let currentLayer = 0;
        let markerMode = false;
        let functionMode = false;
        let developerMode = false;
        let smallCubes = [];
        let selectedCube = null;
        let isDragging = false;
        let previousMousePosition = { x: 0, y: 0 };
        let functionMesh = null;
        let customGeometries = [];
        
        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf8f9fa);
            
            camera = new THREE.PerspectiveCamera(75, 
                document.getElementById('cube-container').clientWidth / 
                document.getElementById('cube-container').clientHeight, 
                0.1, 10000);
            camera.position.set(10, 8, 10);
            
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(
                document.getElementById('cube-container').clientWidth,
                document.getElementById('cube-container').clientHeight
            );
            document.getElementById('cube-container').appendChild(renderer.domElement);
            
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
         
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 20, 15);
            scene.add(directionalLight);
       
            createInfinitePlatform();
            
            cubeGroup = new THREE.Group();
            scene.add(cubeGroup);
            
            updateCube();
            
            animate();
            
            window.addEventListener('resize', onWindowResize);
            
            // 添加事件监听器
            setupEventListeners();
        }
       
        function createInfinitePlatform() {
            const gridSize = 750; // 扩大网格
            const gridDivisions = 75;
            const gridHelper = new THREE.GridHelper(gridSize, gridDivisions, 0x888888, 0xcccccc);
            scene.add(gridHelper);
            
            const planeGeometry = new THREE.PlaneGeometry(gridSize * 2, gridSize * 2);
            const planeMaterial = new THREE.MeshPhongMaterial({ 
                color: 0xeeeeee, 
                transparent: true,
                opacity: 0.5,
                side: THREE.DoubleSide
            });
            platform = new THREE.Mesh(planeGeometry, planeMaterial);
            platform.rotation.x = -Math.PI / 2;
            platform.position.y = -0.1;
            scene.add(platform);
        }
       
        function updateCube() {
            while(cubeGroup.children.length > 0) { 
                cubeGroup.remove(cubeGroup.children[0]); 
            }
            
            const lengthValue = parseInt(document.getElementById('length').value) * 
                               parseFloat(document.getElementById('length-unit').value);
            const widthValue = parseInt(document.getElementById('width').value) * 
                              parseFloat(document.getElementById('width-unit').value);
            const heightValue = parseInt(document.getElementById('height').value) * 
                               parseFloat(document.getElementById('height-unit').value);
        
            document.getElementById('length-value').textContent = document.getElementById('length').value;
            document.getElementById('width-value').textContent = document.getElementById('width').value;
            document.getElementById('height-value').textContent = document.getElementById('height').value;
            
            const volume = lengthValue * widthValue * heightValue;
            const unit = getVolumeUnit();
            document.getElementById('volume').textContent = volume.toLocaleString();
            document.querySelector('.volume-display').innerHTML = 
                `体积 = <span id="volume">${formatVolume(volume)}</span> ${unit}`;
            
            // 标记模式下显示小方块
            if (markerMode) {
                createSmallCubes(lengthValue, heightValue, widthValue);
                return;
            }
            
            const geometry = new THREE.BoxGeometry(lengthValue, heightValue, widthValue);
           
            const materials = [
                new THREE.MeshPhongMaterial({ color: 0x4CAF50 }),
                new THREE.MeshPhongMaterial({ color: 0x2196F3 }), 
                new THREE.MeshPhongMaterial({ color: 0x9e9e9e }), 
                new THREE.MeshPhongMaterial({ color: 0x9e9e9e }), 
                new THREE.MeshPhongMaterial({ color: 0x9e9e9e }),
                new THREE.MeshPhongMaterial({ color: 0x9e9e9e }) 
            ];
            
            cube = new THREE.Mesh(geometry, materials);
            cubeGroup.add(cube);
            
            const edges = new THREE.EdgesGeometry(geometry);
            const line = new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: 0x000000 }));
            cubeGroup.add(line);
            
            const maxDimension = Math.max(lengthValue, widthValue, heightValue);
            const cameraDistance = Math.max(10, maxDimension * 2);
            camera.position.set(cameraDistance, cameraDistance/2, cameraDistance);
            controls.update();
            
            if (layerMode) {
                showLayers(heightValue);
            }
        }
        
        // 创建小方块
        function createSmallCubes(length, height, width) {
            smallCubes = [];
            const unitSize = parseFloat(document.getElementById('length-unit').value);
            
            for (let x = 0; x < parseInt(document.getElementById('length').value); x++) {
                for (let y = 0; y < parseInt(document.getElementById('height').value); y++) {
                    for (let z = 0; z < parseInt(document.getElementById('width').value); z++) {
                        const geometry = new THREE.BoxGeometry(unitSize, unitSize, unitSize);
                        const material = new THREE.MeshPhongMaterial({ 
                            color: 0x3498db,
                            transparent: true,
                            opacity: 0.8
                        });
                        
                        const smallCube = new THREE.Mesh(geometry, material);
                        smallCube.position.set(
                            x * unitSize - (length/2) + unitSize/2,
                            y * unitSize - (height/2) + unitSize/2,
                            z * unitSize - (width/2) + unitSize/2
                        );
                        
                        smallCube.userData = { originalPosition: smallCube.position.clone(), index: {x, y, z} };
                        cubeGroup.add(smallCube);
                        smallCubes.push(smallCube);
                        
                        // 添加边框
                        const edges = new THREE.EdgesGeometry(geometry);
                        const line = new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: 0x000000 }));
                        line.position.copy(smallCube.position);
                        cubeGroup.add(line);
                    }
                }
            }
        }
        
        // 选择小方块
        function selectCube(cube) {
            // 重置之前选中的方块颜色
            if (selectedCube) {
                selectedCube.material.color.set(0x3498db);
            }
            
            selectedCube = cube;
            selectedCube.material.color.set(0xe74c3c);
            
            // 打开注释模态窗口
            document.getElementById('annotation-modal').style.display = 'flex';
        }
        
        // 绘制函数图像
        function plotFunction3D() {
            // 清除之前的函数图像
            if (functionMesh) {
                scene.remove(functionMesh);
            }
            
            const expression = document.getElementById('function-expression').value;
            
            // 创建函数曲面几何体
            const geometry = new THREE.ParametricGeometry((u, v, target) => {
                const x = (u - 0.5) * 20;
                const z = (v - 0.5) * 20;
                
                try {
                    // 使用Function构造函数动态计算y值
                    const func = new Function('x', 'z', `return ${expression};`);
                    const y = func(x, z);
                    target.set(x, y, z);
                } catch (error) {
                    console.error('函数计算错误:', error);
                    target.set(x, 0, z);
                }
            }, 50, 50);
            
            const material = new THREE.MeshPhongMaterial({
                color: 0x9b59b6,
                side: THREE.DoubleSide,
                wireframe: false,
                transparent: true,
                opacity: 0.8
            });
            
            functionMesh = new THREE.Mesh(geometry, material);
            functionMesh.rotation.x = Math.PI / 2;
            scene.add(functionMesh);
            
            // 关闭模态窗口
            document.getElementById('function-modal').style.display = 'none';
        }
        
        // 添加几何体
        function addGeometry(type, size, color) {
            let geometry;
            
            switch(type) {
                case 'sphere':
                    geometry = new THREE.SphereGeometry(size, 32, 32);
                    break;
                case 'cylinder':
                    geometry = new THREE.CylinderGeometry(size, size, size * 2, 32);
                    break;
                case 'cone':
                    geometry = new THREE.ConeGeometry(size, size * 2, 32);
                    break;
                case 'torus':
                    geometry = new THREE.TorusGeometry(size, size/3, 16, 100);
                    break;
                case 'pyramid':
                    geometry = new THREE.ConeGeometry(size, size * 2, 4);
                    break;
                case 'plane':
                    geometry = new THREE.PlaneGeometry(size * 2, size * 2);
                    break;
                default:
                    geometry = new THREE.BoxGeometry(size, size, size);
            }
            
            const material = new THREE.MeshPhongMaterial({ color: color });
            const mesh = new THREE.Mesh(geometry, material);
            
            // 随机位置
            mesh.position.set(
                (Math.random() - 0.5) * 20,
                size,
                (Math.random() - 0.5) * 20
            );
            
            scene.add(mesh);
            customGeometries.push(mesh);
            
            // 关闭模态窗口
            document.getElementById('developer-modal').style.display = 'none';
        }
      
        function getVolumeUnit() {
            const unit = document.getElementById('length-unit').value;
            if (unit === '0.000001') return '立方微米';
            if (unit === '0.001') return '立方毫米';
            if (unit === '1') return '立方厘米';
            if (unit === '10') return '立方分米';
            if (unit === '100') return '立方米';
            return '立方单位';
        }
        
        function formatVolume(volume) {
            if (volume > 1000000) {
                return volume.toExponential(2);
            }
            return volume.toLocaleString();
        }
      
        function showLayers(height) {
            const layerHeight = height / parseInt(document.getElementById('height').value);
            
            for (let i = 0; i < currentLayer; i++) {
                const layerGeometry = new THREE.BoxGeometry(
                    parseInt(document.getElementById('length').value) * 
                    parseFloat(document.getElementById('length-unit').value),
                    layerHeight,
                    parseInt(document.getElementById('width').value) * 
                    parseFloat(document.getElementById('width-unit').value)
                );
                
                const layerMaterial = new THREE.MeshPhongMaterial({ 
                    color: 0xff9800, 
                    transparent: true,
                    opacity: 0.7
                });
                
                const layer = new THREE.Mesh(layerGeometry, layerMaterial);
                layer.position.y = (-height/2) + (i * layerHeight) + (layerHeight/2);
                cubeGroup.add(layer);
          
                const layerEdges = new THREE.EdgesGeometry(layerGeometry);
                const layerLine = new THREE.LineSegments(layerEdges, new THREE.LineBasicMaterial({ color: 0x000000 }));
                layerLine.position.y = (-height/2) + (i * layerHeight) + (layerHeight/2);
                cubeGroup.add(layerLine);
            }
        }
       
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
     
        function onWindowResize() {
            camera.aspect = document.getElementById('cube-container').clientWidth / 
                           document.getElementById('cube-container').clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(
                document.getElementById('cube-container').clientWidth,
                document.getElementById('cube-container').clientHeight
            );
        }
        
        function setupEventListeners() {
            // 原有事件监听
            document.getElementById('length').addEventListener('input', updateCube);
            document.getElementById('width').addEventListener('input', updateCube);
            document.getElementById('height').addEventListener('input', updateCube);
            
            document.getElementById('length-unit').addEventListener('change', updateCube);
            document.getElementById('width-unit').addEventListener('change', updateCube);
            document.getElementById('height-unit').addEventListener('change', updateCube);
            
            document.getElementById('reset').addEventListener('click', function() {
                document.getElementById('length').value = 8;
                document.getElementById('width').value = 3;
                document.getElementById('height').value = 5;
                updateCube();
            });
            
            document.getElementById('clear').addEventListener('click', function() {
                document.getElementById('length').value = 1;
                document.getElementById('width').value = 1;
                document.getElementById('height').value = 1;
                updateCube();
            });
            
            document.getElementById('layer-view').addEventListener('click', function() {
                layerMode = !layerMode;
                if (layerMode) {
                    currentLayer = parseInt(document.getElementById('height').value);
                    this.style.background = '#2c3e50';
                    this.textContent = '整体';
                } else {
                    this.style.background = '#9b59b6';
                    this.textContent = '分层';
                }
                updateCube();
            });
            
            document.getElementById('fullscreen').addEventListener('click', function() {
                const elem = document.getElementById('cube-container');
                if (!document.fullscreenElement) {
                    if (elem.requestFullscreen) {
                        elem.requestFullscreen();
                    } else if (elem.webkitRequestFullscreen) {
                        elem.webkitRequestFullscreen();
                    } else if (elem.msRequestFullscreen) {
                        elem.msRequestFullscreen();
                    }
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    } else if (document.webkitExitFullscreen) {
                        document.webkitExitFullscreen();
                    } else if (document.msExitFullscreen) {
                        document.msExitFullscreen();
                    }
                }
            });
            
            // 新功能事件监听
            document.getElementById('marker-mode').addEventListener('click', function() {
                markerMode = !markerMode;
                if (markerMode) {
                    this.style.background = '#2c3e50';
                    this.textContent = '退出标记';
                } else {
                    this.style.background = '#f39c12';
                    this.textContent = '标记模式';
                }
                updateCube();
            });
            
            document.getElementById('function-mode').addEventListener('click', function() {
                document.getElementById('function-modal').style.display = 'flex';
            });
            
            document.getElementById('developer-mode').addEventListener('click', function() {
                document.getElementById('developer-modal').style.display = 'flex';
            });
            
            document.getElementById('plot-3d').addEventListener('click', plotFunction3D);
            
            document.getElementById('add-geometry').addEventListener('click', function() {
                const type = document.querySelector('.geometry-btn.active')?.dataset.type || 'sphere';
                const size = parseInt(document.getElementById('geo-size').value);
                const color = document.getElementById('geo-color').value;
                addGeometry(type, size, color);
            });
            
            // 关闭模态窗口
            document.querySelectorAll('.close-modal').forEach(closeBtn => {
                closeBtn.addEventListener('click', function() {
                    this.closest('.modal').style.display = 'none';
                });
            });
            
            // 几何体选择
            document.querySelectorAll('.geometry-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.geometry-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            // 小方块选择（射线检测）
            renderer.domElement.addEventListener('dblclick', onDoubleClick);
            renderer.domElement.addEventListener('mousedown', onMouseDown);
            renderer.domElement.addEventListener('mousemove', onMouseMove);
            renderer.domElement.addEventListener('mouseup', onMouseUp);
            
            // 初始化注释画布
            initAnnotationCanvas();
        }
        
        function onDoubleClick(event) {
            if (!markerMode) return;
            
            // 计算鼠标位置归一化设备坐标
            const mouse = new THREE.Vector2();
            mouse.x = (event.clientX / renderer.domElement.clientWidth) * 2 - 1;
            mouse.y = -(event.clientY / renderer.domElement.clientHeight) * 2 + 1;
            
            // 射线投射
            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(mouse, camera);
            
            // 检测与小方块的交互
            const intersects = raycaster.intersectObjects(smallCubes);
            
            if (intersects.length > 0) {
                selectCube(intersects[0].object);
            }
        }
        
        function onMouseDown(event) {
            if (!markerMode || !selectedCube) return;
            
            isDragging = true;
            previousMousePosition = {
                x: event.clientX,
                y: event.clientY
            };
        }
        
        function onMouseMove(event) {
            if (!isDragging || !selectedCube) return;
            
            const deltaMove = {
                x: event.clientX - previousMousePosition.x,
                y: event.clientY - previousMousePosition.y
            };
            
            // 根据鼠标移动更新方块位置
            const worldDirection = new THREE.Vector3();
            camera.getWorldDirection(worldDirection);
            
            selectedCube.position.x += deltaMove.x * 0.01;
            selectedCube.position.y -= deltaMove.y * 0.01;
            
            previousMousePosition = {
                x: event.clientX,
                y: event.clientY
            };
        }
        
        function onMouseUp() {
            isDragging = false;
        }
        
        function initAnnotationCanvas() {
            const canvas = document.getElementById('annotation-canvas');
            const ctx = canvas.getContext('2d');
            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;
            let currentTool = 'pen';
            
            // 设置画布样式
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.strokeStyle = '#000000';
            
            // 工具选择
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentTool = this.dataset.tool;
                });
            });
            
            // 绘图功能
            function draw(e) {
                if (!isDrawing) return;
                
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(e.offsetX, e.offsetY);
                ctx.stroke();
                
                [lastX, lastY] = [e.offsetX, e.offsetY];
            }
            
            // 鼠标事件
            canvas.addEventListener('mousedown', (e) => {
                isDrawing = true;
                [lastX, lastY] = [e.offsetX, e.offsetY];
            });
            
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', () => isDrawing = false);
            canvas.addEventListener('mouseout', () => isDrawing = false);
            
            // 清除画布
            document.getElementById('clear-annotation').addEventListener('click', function() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            });
            
            // 保存注释
            document.getElementById('save-annotation').addEventListener('click', function() {
                if (selectedCube) {
                    // 这里可以将注释与选中的方块关联起来
                    // 例如，将画布内容转换为图像并作为纹理应用到方块上
                    const dataURL = canvas.toDataURL();
                    
                    // 创建纹理
                    const texture = new THREE.TextureLoader().load(dataURL);
                    selectedCube.material.map = texture;
                    selectedCube.material.needsUpdate = true;
                    
                    // 关闭模态窗口
                    document.getElementById('annotation-modal').style.display = 'none';
                }
            });
        }
     
        document.addEventListener('DOMContentLoaded', function() {
            init();
        });
    </script>
</body>
</html>